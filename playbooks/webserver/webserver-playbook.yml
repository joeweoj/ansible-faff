---

- hosts: dev
  become: yes
  become_method: sudo


  vars:
      nginx_conf_src_path: nginx.conf.j2
      nginx_conf_dest_path: /etc/nginx/nginx.conf

      server_conf_src_path: server.conf.j2
      server_conf_dest_path: /etc/nginx/conf.d/server.conf

  tasks:

  # docker
  - name: Uninstall Old Versions
    apt:
      pkg:          "{{ item }}"
      state:        absent
    with_items:
      - docker
      - docker-engine

  - name: Install dependencies
    apt:
      pkg:          "{{ item }}"
      state:        present
      update_cache: true
    with_items:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
      - python-pip

  - name: Install the GPG key
    shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

  - name: Add Docker repository
    apt_repository:
      repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
      state: present

  - name: install certain python modules for docker
    pip:
      name: "{{ item.name }}"
      version: "{{ item.version }}"
      state: present
    with_items:
#    - { name: docker, version: 2.0.0 }
    - { name: docker-py, version: 1.10.6 }

  - name: Install Docker
    apt:
      pkg:          docker-ce=17.03.0~ce-0~ubuntu-xenial
      state:        present
      update_cache: yes

  - name: Install Docker compose
    shell: >
      curl -L https://github.com/docker/compose/releases/download/1.13.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose &&
      sudo chmod +x /usr/local/bin/docker-compose
    become: true

  - name: pull joewardell.com image
    docker_image:
      name: joewardell/joewardell.com
      tag: initial

  - name: pull lingfieldunitedtrust.org image
    docker_image:
      name: joewardell/lingfieldunitedtrust.org
      tag: initial

  - name: joewardell.com container
    docker_container:
      name: joewardell.com
      image: joewardell/joewardell.com:initial
      state: started
      ports:
       - "4000:8080"

  - name: lingfieldunitedtrust.org container
    docker_container:
      name: lingfieldunitedtrust.org
      image: joewardell/lingfieldunitedtrust.org:initial
      state: started
      ports:
       - "5000:80"

  # nginx
  - name: ensure nginx is at latest version
    apt: name=nginx state=latest

  - name: copy nginx config
    template:
      src: "{{ nginx_conf_src_path }}"
      dest: "{{ nginx_conf_dest_path }}"
    notify:
      - restart nginx

  - name: copy server config
    template:
      src: "{{ server_conf_src_path }}"
      dest: "{{ server_conf_dest_path }}"
    notify:
      - restart nginx

  - name: ensure nginx is started (& enabled at boot)
    service: name=nginx state=started enabled=true

  handlers:
  - name: restart nginx
    service: name=nginx state=restarted
  - name: restart docker
    service: name=docker state=restarted